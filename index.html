<!--
File: index.html
Host: GitHub Pages (static). No server here.
Persona goals implemented:
- Per-tag chat history persisted locally by a stable persona key.
- Persona key priority: NFC serialNumber > tag.id > hash(JSON).
- On scan: NFC JSON overwrites stored JSON for that persona (authoritative), and the app switches to that persona and its history only.
- Between sessions: last persona auto-restored (JSON + chat history).
-->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NFC ‚Üí GPT (GitHub Pages)</title>
  <meta name="description" content="Scan NFC tags to apply custom JSON context and chat via a secure relay." />
  <style>
    :root { --gap: 10px; --r: 14px; --pad: 12px; --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 0; }
    header { position: sticky; top: 0; background: #fff; border-bottom: 1px solid #e5e7eb; }
    .wrap { max-width: 980px; margin: 0 auto; padding: var(--pad); }
    h1 { font-size: 18px; margin: 0; }
    .row { display: flex; gap: var(--gap); flex-wrap: wrap; align-items: center; }
    .panel { border: 1px solid #e5e7eb; border-radius: var(--r); padding: var(--pad); background: #fff; }
    button { padding: 10px 14px; border-radius: var(--r); border: 1px solid #d1d5db; background: #fff; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    input[type="text"], input[type="url"], textarea { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: var(--r); }
    textarea { min-height: 160px; font-family: var(--mono); font-size: 13px; }
    .hint { font-size: 12px; opacity: .75; }
    .badge { font-size: 12px; padding: 2px 8px; border: 1px solid #e5e7eb; border-radius: 999px; }
    .pill { border: 1px dashed #d1d5db; padding: 4px 8px; border-radius: 999px; font-size: 12px; }
    .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
    .chat { display: flex; flex-direction: column; gap: 10px; }
    .bubble { padding: 10px 12px; border-radius: 16px; max-width: 85%; white-space: pre-wrap; }
    .user { align-self: flex-end; background: #e5f0ff; }
    .assistant { align-self: flex-start; background: #f3f4f6; }
    .sys { align-self: center; background: #fef9c3; }
    .inputRow { display: grid; grid-template-columns: 1fr auto; gap: var(--gap); }
    code { font-family: var(--mono); }
  </style>
</head>
<body>
  <header>
    <div class="wrap row" style="justify-content:space-between;">
      <div class="row">
        <h1>NFC ‚Üí GPT</h1>
        <span id="nfcSupport" class="badge">Checking NFC‚Ä¶</span>
        <span id="secureCtx" class="badge">Checking HTTPS‚Ä¶</span>
      </div>
      <div class="row">
        <button id="scan">üîé Scan NFC</button>
        <button id="writeExample">‚úçÔ∏è Write Example</button>
        <button id="loadExample">‚¨áÔ∏è Load Example JSON</button>
        <button id="clearChat">üßπ Clear Chat</button>
      </div>
    </div>
  </header>

  <main class="wrap grid">
    <section class="panel">
      <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:6px;">
        <div><strong>Backend Relay</strong> <span class="hint">Required on GitHub Pages (static)</span></div>
        <span id="relayStatus" class="badge">No relay</span>
      </div>
      <div class="row">
        <input id="relayUrl" type="url" placeholder="https://your-relay.example.com/api/chat" style="flex:1;" />
        <button id="saveRelay">Save</button>
        <button id="testRelay">Test</button>
      </div>
      <div class="hint" style="margin-top:6px;">Never paste API keys here. Use a server/edge function; enable CORS for this origin.</div>
    </section>

    <section class="panel">
      <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:6px;">
        <div><strong>Tag JSON</strong> <span class="hint">Editable. Scans overwrite stored JSON for that tag.</span></div>
        <span id="tagId" class="pill">no persona</span>
      </div>
      <textarea id="json" placeholder='Scan an NFC tag (application/json), or click "Load Example JSON"'></textarea>
      <div class="row" style="justify-content:space-between; align-items:center; margin-top: 6px;">
        <div class="hint">Supports NDEF <code>application/json</code>, URL (JSON), or text (JSON fallback to plain text).</div>
        <div class="row" style="gap:6px; align-items:center;">
          <label class="hint">Model:</label><input id="model" type="text" placeholder="(optional e.g. gpt-4o-mini)" style="width:200px;"/>
          <label class="hint">Temp:</label><input id="temp" type="text" placeholder="0.7" style="width:80px;"/>
          <button id="saveJson">Save JSON</button>
        </div>
      </div>
    </section>

    <section class="panel">
      <div style="margin-bottom:8px;"><strong>Chat</strong></div>
      <div id="chat" class="chat"></div>
      <div class="inputRow" style="margin-top: 8px;">
        <input id="msg" type="text" placeholder="Type your message‚Ä¶" />
        <button id="send">Send</button>
      </div>
      <div id="log" class="hint" style="margin-top: 8px; white-space: pre-wrap;"></div>
    </section>
  </main>

  <script>
    // Minimal why-comments only.

    // --- tiny helpers ---
    const $ = (s) => document.querySelector(s);
    const sleep = (ms) => new Promise(r => setTimeout(r, ms));
    const log = (...a) => { const el = $('#log'); el.textContent = [el.textContent, a.join(' ')].filter(Boolean).join('
'); };
    const httpsOK = location.protocol === 'https:' || location.hostname === 'localhost';

    // --- state ---
    let tagContext = null;  // current persona's JSON (authoritative copy)
    let personaKey = null;  // stable key: nfc:<serial> | tag:<id> | hash:<sha256>
    let history = [];       // current persona's chat history

    // --- environment flags ---
    const nfcOK = 'NDEFReader' in window;
    $('#nfcSupport').textContent = nfcOK ? 'Web NFC available' : 'Web NFC unavailable';
    $('#secureCtx').textContent = httpsOK ? 'Secure context' : 'Needs HTTPS';

    // --- persisted relay config ---
    const qsApi = new URLSearchParams(location.search).get('api') || '';
    const savedApi = localStorage.getItem('relayUrl') || '';
    const relayUrl = qsApi || savedApi;
    if (relayUrl) $('#relayUrl').value = relayUrl;
    updateRelayBadge();

    // --- boot: restore last persona if present ---
    (async () => {
      const last = localStorage.getItem('currentPersona');
      if (last) {
        const json = loadTagJSON(last);
        if (json) {
          await setTagContext(json, { key: last, source: 'restore' });
          $('#json').value = JSON.stringify(json, null, 2);
          toast('Restored last persona');
        }
      }
    })();

    // --- UI wiring ---
    $('#saveRelay').addEventListener('click', () => { localStorage.setItem('relayUrl', ($('#relayUrl').value||'').trim()); updateRelayBadge(); toast('Relay saved'); });
    $('#testRelay').addEventListener('click', testRelay);

    $('#loadExample').addEventListener('click', async () => { const ex = exampleTagJSON(); await setTagContext(ex, { source: 'manual' }); $('#json').value = JSON.stringify(ex, null, 2); toast('Loaded example'); });

    $('#saveJson').addEventListener('click', async () => { try { const obj = JSON.parse($('#json').value); if ($('#model').value.trim()) obj.model = $('#model').value.trim(); if ($('#temp').value.trim()) obj.temperature = Number($('#temp').value.trim()); await setTagContext(obj, { key: personaKey, source: 'manual' }); saveTagJSON(personaKey, obj, { overwrite: true }); toast('Saved'); } catch { toast('Invalid JSON'); } });

    $('#clearChat').addEventListener('click', () => { if (personaKey) localStorage.removeItem('history:' + personaKey); history = []; renderChat(); toast('Chat cleared for this persona'); });

    $('#send').addEventListener('click', sendMessage);
    $('#msg').addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });

    $('#scan').addEventListener('click', scanNFC);
    $('#writeExample').addEventListener('click', writeExampleToTag);

    // --- NFC read ---
    async function scanNFC() {
      if (!nfcOK) return toast('Web NFC not supported here');
      if (!httpsOK) return toast('Requires HTTPS (or localhost)');
      try {
        const ndef = new NDEFReader();
        await ndef.scan();
        toast('Bring device to an NFC tag‚Ä¶');
        ndef.onreadingerror = () => toast('Read error');
        ndef.onreading = async (evt) => {
          const parts = [];
          const dec = new TextDecoder();
          for (const rec of evt.message.records) {
            if (rec.recordType === 'mime' && rec.mediaType === 'application/json') {
              try { parts.push(JSON.parse(dec.decode(rec.data))); } catch {}
            } else if (rec.recordType === 'url') {
              const url = dec.decode(rec.data);
              try { const obj = await fetchJSON(url); if (obj) parts.push(obj); } catch (e) { log('URL fetch failed:', e.message || e); }
            } else if (rec.recordType === 'text') {
              const text = new TextDecoder(rec.encoding || 'utf-8').decode(rec.data);
              try { parts.push(JSON.parse(text)); } catch { parts.push({ contextText: text }); }
            }
          }
          const merged = deepMergeAll(parts);
          const key = await personaKeyFrom(merged, evt?.serialNumber || null);

          // Overwrite stored JSON for this persona with freshly scanned data.
          saveTagJSON(key, merged, { overwrite: true });

          await setTagContext(merged, { key, source: 'scan' });
          $('#json').value = JSON.stringify(merged, null, 2);
          toast('Tag read ‚úî persona set');
        };
      } catch (e) { toast('Scan failed: ' + (e?.message || e)); }
    }

    // --- NFC write (example) ---
    async function writeExampleToTag() {
      // Why: quick provisioning of demo tags.
      if (!nfcOK) return toast('Web NFC not supported here');
      if (!httpsOK) return toast('Requires HTTPS (or localhost)');
      try {
        const ndef = new NDEFReader();
        await ndef.write({ records: [{ recordType: 'mime', mediaType: 'application/json', data: new TextEncoder().encode(JSON.stringify(exampleTagJSON())) }] });
        toast('Wrote example JSON to tag');
      } catch (e) { toast('Write failed: ' + (e?.message || e)); }
    }

    // --- chat send ---
    async function sendMessage() {
      const msg = $('#msg').value.trim();
      if (!msg) return;
      const api = ($('#relayUrl').value || '').trim();
      if (!api) return toast('Set a relay URL first');
      if (!tagContext || !personaKey) return toast('Load/scan tag JSON first');

      $('#msg').value = '';
      history.push({ role: 'user', content: msg });
      renderChat();

      const body = { tagContext: enrichFromInputs(tagContext), message: msg, history };
      try {
        const r = await fetch(api, { method: 'POST', headers: { 'content-type': 'application/json' }, body: JSON.stringify(body) });
        const j = await r.json();
        if (!r.ok) throw new Error(j?.detail || JSON.stringify(j));
        history.push({ role: 'assistant', content: j.reply || '' });
        saveHistory(personaKey, history);
        renderChat();
      } catch (e) {
        history.push({ role: 'system', content: 'Error: ' + (e?.message || e) });
        renderChat();
      }
    }

    // --- persona helpers ---
    async function setTagContext(obj, opts = {}) {
      const key = opts.key || await personaKeyFrom(obj, opts.serialNumber || null);
      tagContext = obj && typeof obj === 'object' ? obj : {};
      personaKey = key;
      localStorage.setItem('currentPersona', key);

      // Update UI label
      const label = key.length > 20 ? key.slice(0, 20) + '‚Ä¶' : key;
      $('#tagId').textContent = label || 'no persona';

      // Load persona-specific history
      history = loadHistory(key);
      renderChat();

      // Align inputs with tag defaults
      if ($('#model').value.trim() === '' && obj?.model) $('#model').value = obj.model;
      if ($('#temp').value.trim() === '' && obj?.temperature != null) $('#temp').value = String(obj.temperature);
    }

    async function personaKeyFrom(obj, serial) {
      if (serial && String(serial).trim()) return 'nfc:' + String(serial).trim();
      const id = obj && typeof obj === 'object' ? (obj.id ?? obj.tagId ?? obj.slug) : null;
      if (id && String(id).trim()) return 'tag:' + String(id).trim();
      return 'hash:' + await sha256hex(JSON.stringify(obj || {}));
    }

    function saveTagJSON(key, obj, { overwrite = true } = {}) {
      try {
        if (!key) return;
        if (!overwrite) {
          const existing = loadTagJSON(key);
          if (existing) return;
        }
        localStorage.setItem('tagjson:' + key, JSON.stringify(obj));
      } catch {}
    }
    function loadTagJSON(key) {
      try { return JSON.parse(localStorage.getItem('tagjson:' + key) || 'null'); } catch { return null; }
    }

    function loadHistory(key) { try { return JSON.parse(localStorage.getItem('history:' + key) || '[]'); } catch { return []; } }
    function saveHistory(key, hist) { try { localStorage.setItem('history:' + key, JSON.stringify(hist)); } catch {} }

    // --- misc utils ---
    function enrichFromInputs(tc) {
      const x = JSON.parse(JSON.stringify(tc || {}));
      const m = $('#model').value.trim(); if (m) x.model = m;
      const t = $('#temp').value.trim(); if (t !== '') x.temperature = Number(t);
      return x;
    }

    function exampleTagJSON() {
      return {
        id: 'exhibit-42',
        name: 'Gallery Exhibit #42',
        model: 'gpt-4o-mini',
        temperature: 0.5,
        system: 'You are a friendly museum docent embedded in a kiosk.',
        instructions: 'Always tailor answers to visitors at Gallery #42. When uncertain, ask a clarifying question first.',
        metadata: { venue: 'Main Museum', floor: 2, area: 'Modern' },
        facts: [ 'Artist: Ada Chu (b. 1986)', 'Medium: Reclaimed aluminum & LED', 'Installed: 2023', 'Safe viewing distance: 1 meter' ],
        context: [ { title: 'Work Title', summary: '\"Luminous Echoes\" explores perception via light reflections.' }, { title: 'Theme', summary: 'Sustainability and reuse of materials in art.' } ]
      };
    }

    function deepMergeAll(arr) { if (!Array.isArray(arr) || arr.length === 0) return {}; return arr.reduce((a,b)=>deepMerge(a,b),{}); }
    function deepMerge(a,b){ if(Array.isArray(a)&&Array.isArray(b))return[...a,...b]; if(isObj(a)&&isObj(b)){const o={...a}; for(const k of Object.keys(b)) o[k]=deepMerge(a[k],b[k]); return o;} return b===undefined?a:b; }
    function isObj(x){ return x && typeof x==='object' && !Array.isArray(x); }

    async function sha256hex(str){ const bytes=new TextEncoder().encode(str); const hash=await crypto.subtle.digest('SHA-256', bytes); return [...new Uint8Array(hash)].map(b=>b.toString(16).padStart(2,'0')).join(''); }
    async function fetchJSON(url){ const r=await fetch(url,{headers:{'accept':'application/json'}}); if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); }

    function toast(s){ log('‚Ä¢ '+s); }
    function updateRelayBadge(){ const v=($('#relayUrl').value||'').trim(); $('#relayStatus').textContent = v ? 'Relay set' : 'No relay'; }

    async function testRelay(){ const api=($('#relayUrl').value||'').trim(); if(!api) return toast('Set a relay URL first'); try { const r=await fetch(api,{method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({ tagContext:{ system: 'You are a health check.' }, message:'ping', history: [] })}); const j=await r.json(); if(!r.ok) throw new Error(j?.detail || JSON.stringify(j)); toast('Relay OK'); } catch(e){ toast('Relay test failed: '+(e?.message||e)); } }
  </script>
</body>
</html>
